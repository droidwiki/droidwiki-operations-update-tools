resource_types:
  - name: mediawiki-version-resource
    type: docker-image
    source:
      repository: droidwiki/mediawiki-version-resource
      tag: latest
  - name: ssh
    type: docker-image
    source:
      repository: droidwiki/concourse-ssh-resource
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:
  - name: mediawiki-version
    type: mediawiki-version-resource
    source:
      mediawikiUrl: https://de.wikipedia.org
  - name: staging-server
    type: ssh
    source:
      host: 188.68.49.74
      user: ((ssh.username))
      private_key: ((ssh.private_key))
      timeout: 1800
  - name: slack-feed
    type: slack-notification
    source:
      url: ((slack.webhook_url))
  - name: mediawiki-config
    type: git
    source:
      uri: https://github.com/droidwiki/operations-mediawiki-config.git
  - name: update-tools
    type: git
    source:
      uri: https://github.com/droidwiki/operations-update-tools.git
  - name: daily
    type: time
    source:
      start: 12:00 AM
      stop: 1:00 AM

jobs:
  - name: update-tools
    serial: true
    plan:
      - get: update-tools
        trigger: true
      - put: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            ref="|update-tools-ref|"

            echo "((ssh.private_key))" > /tmp/ssh-key
            chmod 600 /tmp/ssh-key
            eval `ssh-agent -s`
            ssh-add /tmp/ssh-key

            cd /data/deployment/bin/

            git fetch && git checkout $ref
          placeholders:
            - name: "|update-tools-ref|"
              file: update-tools/.git/ref
        ensure:
          put: staging-server
          params:
            interpreter: /bin/bash
            script: |
              export TERM=dumb
              set -e

              rm -rf /tmp/ssh-key
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of update-tools failed. :sob:"
    
  - name: update-mediawiki
    serial: true
    plan:
      - get: mediawiki-version
        trigger: true
      - get: update-tools
        trigger: true
        passed: [update-tools]
      - put: update mediawiki
        resource: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            set -x
            cd /data/deployment/staging/main/
            branch="|mediawiki-version|"

            rm -rf extensions
            rm -rf skins
            git fetch
            git checkout $branch
            
            cd .. && ./create-links.sh
          placeholders:
            - name: "|mediawiki-version|"
              file: mediawiki-version/git-branch
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of mediawiki failed. :sob:"
      - put: update extensions
        resource: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            set -x
            cd /data/deployment/staging/extensions/
            branch="|mediawiki-version|"
            newVersion=${branch:4}

            ../../bin/update-list.sh ../../bin/extensions.list $newVersion
          placeholders:
            - name: "|mediawiki-version|"
              file: mediawiki-version/git-branch
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of extensions failed. :sob:"
      - put: update skins
        resource: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            set -x
            cd /data/deployment/staging/skins/
            branch="|mediawiki-version|"
            newVersion=${branch:4}

            ../../bin/update-list.sh ../../bin/skins.list $newVersion
          placeholders:
            - name: "|mediawiki-version|"
              file: mediawiki-version/git-branch
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of skins failed. :sob:"

  - name: update-composer
    serial: true
    plan:
      - get: mediawiki-version
        passed: [update-mediawiki]
        trigger: true
      - get: update-tools
        trigger: true
        passed: [update-mediawiki]
      - put: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            set -x
            cd /data/deployment/staging/main

            composer update --no-dev
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of composer failed. :sob:"

  - name: update-mediawiki-config
    serial: true
    plan:
      - get: mediawiki-config
        trigger: true
      - task: test config
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: composer
              tag: latest
          inputs:
            - name: mediawiki-config
          run:
            path: bash
            args:
              - -ec
              - |
                cd mediawiki-config
                composer update --ansi --no-progress --prefer-dist --profile -v

                composer test
      - put: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e
            ref="|mediawiki-config-ref|"

            echo "((ssh.private_key))" > /tmp/ssh-key
            chmod 600 /tmp/ssh-key
            eval `ssh-agent -s`
            ssh-add /tmp/ssh-key

            cd /data/deployment/staging/mw-config/mw-config

            git fetch && git checkout $ref

            composer update --ansi --no-progress --prefer-dist --profile -v --no-dev
          placeholders:
            - name: "|mediawiki-config-ref|"
              file: mediawiki-config/.git/ref
        ensure:
          put: staging-server
          params:
            interpreter: /bin/bash
            script: |
              export TERM=dumb
              set -e

              rm -rf /tmp/ssh-key
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Updating of composer failed. :sob:"

  - name: deploy
    serial: true
    plan:
      - get: mediawiki-version
        passed: [update-composer]
      - get: mediawiki-config
        passed: [update-mediawiki-config]
        trigger: true
      - put: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e

            echo "((ssh.private_key))" > /tmp/ssh-key
            chmod 600 /tmp/ssh-key
            eval `ssh-agent -s`
            ssh-add /tmp/ssh-key

            cd /data/deployment/deploy/

            ./deploy --updatedb --updatei18n
        ensure:
          put: staging-server
          params:
            interpreter: /bin/bash
            script: |
              export TERM=dumb
              set -e

              rm -rf /tmp/ssh-key
        on_failure:
          put: slack-feed
          params:
            text: ":eyes: Deployment of new mediawiki version failed. :sob:"
        on_success:
          put: slack-feed
          params:
            text: ":tada: Deployment of new mediawiki version finished! :heart_eyes:"

  - name: update-sitemaps
    serial: true
    plan:
      - get: daily
        trigger: true
      - put: staging-server
        params:
          interpreter: /bin/bash
          script: |
            export TERM=dumb
            set -e

            echo "((ssh.private_key))" > /tmp/ssh-key
            chmod 600 /tmp/ssh-key
            eval `ssh-agent -s`
            ssh-add /tmp/ssh-key

            cd /data/deployment/deploy/

            ./deploy --skipupdatewiki
        ensure:
          put: staging-server
          params:
            interpreter: /bin/bash
            script: |
              export TERM=dumb
              set -e

              rm -rf /tmp/ssh-key
